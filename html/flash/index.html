<html>
<head><title>Upgrade firmware</title>
<link rel="stylesheet" type="text/css" href="../wifi/style.css">
<script type="text/javascript" src="../wifi/140medley.min.js"></script>
<script type="text/javascript">

var xhr=j();

function doCommonXHR(donecallback, responsecallback) {
	xhr.onreadystatechange=function() {
        if (xhr.readyState==4) {
            if (xhr.status>=200 && xhr.status<=400) {
                var json_response = JSON.parse(xhr.responseText);
                if (responsecallback && typeof(responsecallback) === "function") {responsecallback(json_response);}
            }
            else
            {
                $("#remark").innerHTML="<strong style=\"color: red;\">Error!  Check connection.  HTTP status: " + xhr.status + "</strong>";
            }
            if (donecallback && typeof(donecallback) === "function") {donecallback();}
        }
	}
}

function doReboot(callback) {
	$("#remark").innerHTML="Sending reboot command...";
	xhr.open("GET", "./reboot");
    doCommonXHR(callback, function(json_response) {
        if (json_response.success == false) {
            $("#remark").innerHTML="<strong style=\"color: red;\">Error: "+xhr.responseText+"</strong>";
        } else {
            $("#remark").innerHTML="Command sent.  Rebooting!...";
        }
        window.setTimeout(function() {
            location.reload(true);
        }, 4000);
    });
	xhr.send();
	return false;
}

function doSetBoot(partition, callback) {
	$("#remark").innerHTML="Setting Boot Flag to partition: " + partition + "...";
	xhr.open("GET", "./setboot" + ((partition)?("?partition=" + partition):("")));
    doCommonXHR(callback, function(json_response) {
        doInfo(function() {
            setProgress(1);
            if (json_response.success == false) {
                $("#remark").innerHTML="<strong style=\"color: red;\">Error: "+xhr.responseText+"</strong>";
            } else {
                $("#remark").innerHTML="Finished setting Boot Flag to " + partition + ".  <b>Now press Reboot!</b>";
            }
        });
    });
	xhr.send();
	return false;
}

function doEraseFlash(partition, callback) {
	$("#remark").innerHTML="Erasing data in: " + partition + "...";
	xhr.open("GET", "./erase" + ((partition)?("?partition=" + partition):("")));
    doCommonXHR(callback, function(json_response) {
        doInfo(function() {
            setProgress(1);
            if (json_response.success == false) {
                $("#remark").innerHTML="<strong style=\"color: red;\">Error: "+xhr.responseText+"</strong>";
            } else {
                $("#remark").innerHTML="Finished erasing data in: " + partition + ".  <b>Must reboot to reformat it!</b>";
            }
        });
    });
	xhr.send();
	return false;
}

function setProgress(amt) {
	$("#progressbarinner").style.width=String(amt*200)+"px";
}

function doUpgrade(partition, callback) {
	var f=$("#file").files[0];
	if (typeof f=='undefined') {
		$("#remark").innerHTML="<strong style=\"color: red;\">Can't read file!  Browse for .bin file.</strong>";
		return
	}

	xhr.upload.onprogress=function(e) {
		setProgress(e.loaded / e.total);
	}
	$("#remark").innerHTML="Uploading App to partition: " + partition;
	xhr.open("POST", "./upload" + ((partition)?("?partition=" + partition):("")));
    doCommonXHR(callback, function(json_response) {
        doInfo(function() {
            setProgress(1);
            if (json_response.success == false) {
                $("#remark").innerHTML="<strong style=\"color: red;\">Error: "+json_response.message+"</strong>";
            } else {
                $("#remark").innerHTML="Upload flash done and Boot Set. <b>Now Reboot!</b>";
                // doReboot();
            }
        });
    });
    xhr.send(f);
	return false;
}

function humanFileSize(B,i){var e=i?1e3:1024;if(Math.abs(B)<e)return B+" B";var a=i?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],t=-1;do B/=e,++t;while(Math.abs(B)>=e&&t<a.length-1);return B.toFixed(3)+" "+a[t]}

function doInfo(callback) {
    var dataformats = {0: "ota_data", 1: "phy_init", 2: "nvs", 3: "coredump", 0x81: "fat", 0x82: "spiffs"};
	xhr.open("GET", "./flashinfo.json");
    doCommonXHR(callback, function(flinfo) {
        var tablerows = "";
        for(var i=0;i<flinfo.app.length;i++)
        {
             tablerows += "<tr>"
                         + "<td>" + flinfo.app[i].name + "</td>"
                         + "<td>" + humanFileSize(flinfo.app[i].size,0) + "</td>"
                         + "<td>" + flinfo.app[i].version + "</td>"
                         + "<td>" + ((flinfo.app[i].valid)?("&#10004;"):("")) + "</td>"
                         + "<td>" + ((flinfo.app[i].running)?("&#10004;"):("")) + "</td>"
                         + '<td>' + ((flinfo.app[i].bootset)?("&#10004;"):((flinfo.app[i].valid)?('<input type="submit" value="Set Boot ' + flinfo.app[i].name + '!" onclick="doSetBoot( \'' + flinfo.app[i].name + '\')" />'):(''))) + '</td>'
                         + '<td>' + (((flinfo.app[i].ota) && !(flinfo.app[i].running))?('<input type="submit" value="Upload to ' + flinfo.app[i].name + '!" onclick="doUpgrade( \'' + flinfo.app[i].name + '\')" />'):('')) + '</td>'
                         + "</tr>";
        };
        $('#tbodyApp').innerHTML=tablerows;
        tablerows = "";
        for(var i=0;i<flinfo.data.length;i++)
        {
             tablerows += "<tr>"
                         + "<td>" + flinfo.data[i].name + "</td>"
                         + "<td>" + humanFileSize(flinfo.data[i].size,0) + "</td>"
                         + "<td>" + dataformats[flinfo.data[i].format] + "</td>"
                         + '<td>' + ('<input type="submit" value="Erase ' + flinfo.data[i].name + '!" onclick="doEraseFlash( \'' + flinfo.data[i].name + '\')" />') + '</td>'
                         + "</tr>";
        };
        $('#tbodyData').innerHTML=tablerows;
    });
	xhr.send();
	return false;
}

window.onload=function(e) {
    setProgress(0);
	doInfo(function(){$("#remark").innerHTML="Ready.";});
}

</script>
</head>
<body>
<div id="main">
<h1>Upgrade Firmware</h1>

<p><table style="width: 100%">
<caption><b>App Partitions</b></caption>
     <thead>
          <tr>
               <th>Partition Name</th>
               <th>Partition Size</th>
               <th>App Version</th>
               <th>App Valid</th>
               <th>App Running</th>
               <th>App Set Boot</th>
               <th>App Upload <br/><input type="file" id="file" /></th>
           </tr>
     </thead>
     <tbody id="tbodyApp">
     </tbody>
</table></p>

<p><table style="width: 100%">
<caption><b>Data Partitions</b></caption>
     <thead>
          <tr>
               <th>Partition Name</th>
               <th>Partition Size</th>
               <th>Data Type</th>
               <th>Erase</th>
           </tr>
     </thead>
     <tbody id="tbodyData">
     </tbody>
</table></p>
<input type="submit" value="Reboot!" onclick="doReboot()" />
<div><p id="remark">Loading...</p></div>
<div id="progressbar"><div id="progressbarinner"></div></div>
</div>
</body>
</html>